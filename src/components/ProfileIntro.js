import React, { useState, useRef, useEffect } from 'react';
import { useNavigate, useLocation } from 'react-router-dom';
import debounce from 'lodash/debounce';
import ProfileIntroHeader from './ProfileIntroHeader';
import VideoSlide from './VideoSlide'; // Í≤ΩÎ°úÏóê ÎßûÍ≤å

function useDebounce(callback, delay) {
  const timer = useRef(null);

  return (...args) => {
    if (timer.current) clearTimeout(timer.current);
    timer.current = setTimeout(() => {
      callback(...args);
    }, delay);
  };
}

function shouldBlurPhoto({ isUnlocked, isFullyUnlocked, userId, profileUserId, photoUrl, avatarUrl }) {
  if (isFullyUnlocked || userId === profileUserId) return false;
  if (photoUrl === avatarUrl) return false;
  // if (!isUnlocked) return true;

  // Î∞∞Ïó¥Î°ú ÏôîÏùÑ Îïå Ìï¥Îãπ ÏÇ¨ÏßÑÏù¥ Ìè¨Ìï®ÎêòÏñ¥ ÏûàÏñ¥ÏïºÎßå Î∏îÎü¨ Ìï¥Ï†ú
  if (Array.isArray(isUnlocked)) {
    return !isUnlocked.includes(photoUrl);
  }  

  return false;
}

function ProfileIntro() {
  const location = useLocation();
  const navigate = useNavigate();
  const sliderRef = useRef(null);
  console.log('[ProfileIntro] location.state:', location.state);
  console.log('[ProfileIntro] Î∞õÏùÄ photos:', location.state?.photos);
  //const photos = location.state?.photos || [];

  // location.stateÍ∞Ä ÏóÜÏúºÎ©¥ Îπà Í∞ùÏ≤¥Î°ú Ï¥àÍ∏∞Ìôî
  const state = location.state || {};

  //const photos = location.state?.photos || [];



  const {
    photos: rawPhotos = [],
    isUnlocked = false,
    isFullyUnlocked = false,
    userId = null,
    profileUserId = null,
    avatarUrl = '',
    startIndex = 0,
  } = location.state || {};

console.log('[ProfileIntro] location.state:', location.state);
   let photos = Array.isArray(rawPhotos) ? rawPhotos : [rawPhotos];

  // photos Î∞∞Ïó¥ÏùÑ Î∞õÏïÑÏò§Îêò, Î∞∞Ïó¥ ÏïÑÎãàÎ©¥ Î∞∞Ïó¥Î°ú Î≥ÄÌôò
  //let photos = state.photos || [];  
  if (!Array.isArray(photos)) photos = [photos];
console.log('[ProfileIntro] photos:========', photos);
  // const startIndex = state.startIndex || 0;
  // const isUnlocked = state.isUnlocked || false;
  // const isFullyUnlocked = state.isFullyUnlocked || false;
  // const userId = state.userId || null;
  // const profileUserId = state.profileUserId || null;
  // const avatarUrl = state.avatarUrl || '';


   console.log('[ProfileIntro] Î∞õÏùÄ photos:', rawPhotos);

  const [currentIndex, setCurrentIndex] = useState(startIndex);
  const currentIndexRef = useRef(currentIndex);

  // Ï¥àÍ∏∞ ÏúÑÏπò ÎßûÏ∂§(useEffect)
  useEffect(() => {
    if (!sliderRef.current) return;

    const width = sliderRef.current.clientWidth;
    if (width === 0) {
      setTimeout(() => {
        sliderRef.current.scrollTo({
          left: startIndex * width,
          behavior: 'auto',
        });
        setCurrentIndex(startIndex);
        currentIndexRef.current = startIndex;
      }, 50);
      return;
    }
    sliderRef.current.scrollTo({
      left: startIndex * width,
      behavior: 'auto',
    });
    setCurrentIndex(startIndex);
    currentIndexRef.current = startIndex;
  }, [startIndex, photos]);

  // Ï†ïÌôïÌïú ÏúÑÏπòÎ°ú Ïä§ÌÅ¨Î°§ Ïù¥Îèô
  useEffect(() => {
    if (sliderRef.current) {
      sliderRef.current.scrollTo({
        left: currentIndex * sliderRef.current.clientWidth,
        behavior: 'smooth',
      });
    }
    currentIndexRef.current = currentIndex; // refÎèÑ Í∞ôÏù¥ ÏóÖÎç∞Ïù¥Ìä∏
  }, [currentIndex]);

  // ÎîîÎ∞îÏö¥Ïä§Îêú Ïù∏Îç±Ïä§ ÏÑ§Ï†ï Ìï®Ïàò
  const debouncedSetCurrentIndex = useDebounce((index) => {
    setCurrentIndex(index);
  }, 200);  // 100~200msÎ°ú ÎäòÎ†§Î≥¥ÏÑ∏Ïöî


  const isUserScrolling = useRef(false);

  // Ïä§ÌÅ¨Î°§ Ïãú Ïù∏Îç±Ïä§ Í≥ÑÏÇ∞
  const onScroll = () => {
    if (!sliderRef.current) return;

    isUserScrolling.current = true;

    const slider = sliderRef.current;
    const scrollLeft = slider.scrollLeft;
    const width = slider.clientWidth;
    if (width === 0) return;

    let index = Math.round(scrollLeft / width);

    // Ïù∏Îç±Ïä§ Î≤îÏúÑ Ï†úÌïú
    if (index < 0) index = 0;
    if (index >= photos.length) index = photos.length - 1;

    // ÎÑàÎ¨¥ ÌÅ∞ Î≥ÄÌôîÎäî Î¨¥Ïãú
    if (Math.abs(index - currentIndexRef.current) > 1) return;

    debouncedSetCurrentIndex(index);
  };

  // Ïä§ÌÅ¨Î°§Ïù¥ ÎÅùÎÇ¨ÏùÑ Îïå Í∞ïÏ†ú Ìï¥Ï†ú
  useEffect(() => {
    const handleScrollEnd = debounce(() => {
      isUserScrolling.current = false;
    }, 200);

    const slider = sliderRef.current;
    if (slider) {
      slider.addEventListener('scroll', handleScrollEnd);
      return () => slider.removeEventListener('scroll', handleScrollEnd);
    }
  }, []);  

  const goToPrevious = () => {
    if (!isUserScrolling.current && currentIndex > 0) {
      const newIndex = currentIndex - 1;
      setCurrentIndex(newIndex);
      currentIndexRef.current = newIndex;
    }
  };

  const goToNext = () => {
    if (!isUserScrolling.current && currentIndex < photos.length - 1) {
      const newIndex = currentIndex + 1;
      setCurrentIndex(newIndex);
      currentIndexRef.current = newIndex;
    }
  };

  return (
   
    <div style={styles.container}>
     {/* <div style={{ padding: '0 16px 16px 16px' }}> */}
      <div style={{ marginTop: 0, paddingTop: 0 }}>
        <ProfileIntroHeader />
      </div>     

      <div style={styles.sliderWrapper}>
        {photos.length > 1 && (
          <button style={styles.navLeft} onClick={goToPrevious}>{'<'}</button>
        )}

        <div
          ref={sliderRef}
          style={styles.slider}
          onScroll={onScroll}
        >
        {photos.map((url, idx) => {
          const isBlurred = shouldBlurPhoto({
            isUnlocked,
            isFullyUnlocked,
            userId,
            profileUserId,
            photoUrl: url,
            avatarUrl,
          });

          const isVideo = url.toLowerCase().endsWith('.mp4');
          // const videoRef = useRef(null);
          // const [isPlaying, setIsPlaying] = useState(false);

          // const handlePlay = () => {
          //   videoRef.current?.play();
          //   setIsPlaying(true);
          // };
          return (
            // <div key={idx} style={{ ...styles.slide, position: 'relative' }}>
            //   {isVideo ? (
            //   <>
            //     <video
            //       ref={videoRef}
            //       src={url}
            //       playsInline
            //       style={{
            //         ...styles.image,
            //         filter: isBlurred ? 'blur(8px)' : 'none',
            //         transition: 'filter 0.3s ease',
            //       }}
            //     />
            //     {!isPlaying && (
            //       <button
            //         onClick={handlePlay}
            //         style={{
            //           position: 'absolute',
            //           bottom: '10px',
            //           right: '10px',
            //           background: 'rgba(0,0,0,0.6)',
            //           color: '#fff',
            //           border: 'none',
            //           borderRadius: '50%',
            //           width: '36px',
            //           height: '36px',
            //           fontSize: '16px',
            //           cursor: 'pointer',
            //         }}
            //       >
            //         ‚ñ∂
            //       </button>
            //     )}
            //   </>                
            //   ) : (
            //     <img
            //       src={url}
            //       alt={`photo-${idx}`}
            //       style={{
            //         ...styles.image,
            //         filter: isBlurred ? 'blur(8px)' : 'none',
            //         transition: 'filter 0.3s ease',
            //       }}
            //     />
            //   )}
            // </div>
            <div key={idx} style={styles.slide}>
              {isVideo ? (
                <VideoSlide url={url} isBlurred={isBlurred} style={styles.image} />
              ) : (
                <img
                  src={url}
                  alt={`photo-${idx}`}
                  style={{
                    ...styles.image,
                    filter: isBlurred ? 'blur(8px)' : 'none',
                    transition: 'filter 0.3s ease',
                  }}
                />
              )}
            </div>            
          );
        })}
        </div>

        {photos.length > 1 && (
          <button style={styles.navRight} onClick={goToNext}>{'>'}</button>
        )}
      </div>

      <div style={styles.dots}>
        {photos.map((_, idx) => (
          <div
            key={idx}
            style={{
              ...styles.dot,
              backgroundColor: idx === currentIndex ? '#ff3366' : '#ccc',
            }}
          />
        ))}
      </div>

      <footer style={styles.footer}>
        <div style={styles.footerButton} onClick={() => navigate('/')}>üè†</div>
        <div style={styles.footerButton} onClick={() => navigate('/search')}>üîç</div>
        <div style={styles.footerButton} onClick={() => navigate('/favorites')}>üíò</div>
        <div style={styles.footerButton} onClick={() => navigate('/chat')}>üí¨</div>
        <div style={styles.footerButton} onClick={() => navigate('/mypage')}>üë§</div>
      </footer>
    </div>
  );
}

const styles = {
  container: {
    height: '100vh',
    width: '100vw',
    backgroundColor: '#000',
    color: '#fff',
    display: 'flex',
    flexDirection: 'column',
  },
  header: {
    height: 60,
    display: 'flex',
    alignItems: 'center',
    padding: '0 1.5rem',
    borderBottom: '1px solid #ddd',
    width: '100%',
    boxSizing: 'border-box',
    flexShrink: 0,
    color: '#000',
    backgroundColor: '#fff',
    position: 'relative',
  },
  backButton: {
    fontSize: 24,
    cursor: 'pointer',
    background: 'none',
    border: 'none',
    color: '#000',
  },
  title: {
    flex: 1,
    textAlign: 'center',
    margin: 0,
    fontWeight: 'bold',
    fontSize: 20,
    color: '#000',
  },
  closeButton: {
    fontSize: 24,
    cursor: 'pointer',
    background: 'none',
    border: 'none',
    color: '#000',
    position: 'absolute',
    right: 20,
    top: '50%',
    transform: 'translateY(-50%)',
  },
  sliderWrapper: {
    position: 'relative',
    flex: 1,
    display: 'flex',
    alignItems: 'center',
    overflow: 'hidden',   // Ïä¨ÎùºÏù¥Îçî Î∞îÍπ•Ï™Ω Ïä§ÌÅ¨Î°§ Ïà®Í∏∞Í∏∞
  },
  // Ïä§ÌÅ¨Î°§Î∞î Ïà®Í∏∞Í∏∞ (ÏõπÌÇ∑ Í∏∞Î∞ò Î∏åÎùºÏö∞Ï†Ä)
  slider: {
    display: 'flex',
    flexDirection: 'row',  // Í∞ÄÎ°ú Î∞∞Ïπò
    overflowX: 'auto',
    scrollSnapType: 'x mandatory',
    scrollbarWidth: 'none',  // (optional) Ïä§ÌÅ¨Î°§Î∞î Ïà®Í∏∞Í∏∞
    msOverflowStyle: 'none', // (optional) IE, Edge Ïä§ÌÅ¨Î°§Î∞î Ïà®Í∏∞Í∏∞
  },
  slide: {
    flexShrink: 0,
    width: '100%', // Ìïú Ïä¨ÎùºÏù¥ÎìúÍ∞Ä Î∂ÄÎ™® Ïä¨ÎùºÏù¥Îçî ÎÑàÎπÑ 100%
    scrollSnapAlign: 'start',
    position: 'relative',  // (ÌïÑÏöîÏãú)
  },
  image: {
    width: '100%',
    height: 'auto',
    display: 'block',
    objectFit: 'cover', // ÎπÑÏú® Ïú†ÏßÄÌïòÎ©∞ ÍΩâ Ï±ÑÏö∞Í∏∞
  },  
  navLeft: {
    position: 'absolute',
    left: 10,
    zIndex: 1,
    fontSize: 30,
    color: '#fff',
    background: 'transparent',
    border: 'none',
    cursor: 'pointer',
  },
  navRight: {
    position: 'absolute',
    right: 10,
    zIndex: 1,
    fontSize: 30,
    color: '#fff',
    background: 'transparent',
    border: 'none',
    cursor: 'pointer',
  },
  dots: {
    display: 'flex',
    justifyContent: 'center',
    padding: 10,
    gap: 8,
    backgroundColor: '#111',
  },
  dot: {
    width: 10,
    height: 10,
    borderRadius: '50%',
    backgroundColor: '#ccc',
    transition: 'background-color 0.3s ease',
  },
  footer: {
    height: 60,
    backgroundColor: '#fff', // Î≥ÄÍ≤ΩÎêú Î∂ÄÎ∂Ñ
    display: 'flex',
    justifyContent: 'space-around',
    alignItems: 'center',
  },
  footerIcon: {
    fontSize: 28,
    cursor: 'pointer',
    color: '#000', // Ìù∞ Î∞∞Í≤ΩÏóê Ïñ¥Ïö∏Î¶¨ÎèÑÎ°ù Í≤ÄÏùÄÏÉâ
  },
  footerButton: {
    fontSize: 20,
    cursor: 'pointer',
  },  
};

export default ProfileIntro;